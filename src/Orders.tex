\documentclass{article}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}

\usepackage{todonotes}

% Theorems
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}{Corollary}
\newtheorem{observation}{Observation}
\newtheorem{observations}{Observations}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{claim}{Claim}

% Definitions
\newtheorem{definition}{Definition}
\newtheorem{definitions}{Definitions}
\newtheorem{notation}{Notation}
\newtheorem{notations}{Notations}

% Delimiters
\newcommand{\parens}[1]{\left( {#1} \right)}
\newcommand{\brackets}[1]{\left[ {#1} \right]}
\newcommand{\braces}[1]{\left\{ {#1} \right\}}

% Macros
\newcommand{\setcomp}[1]{\braces{#1}}
\newcommand{\hrank}[1]{\mathbf{hrank}_{\qq}\left( #1 \right)}
\newcommand{\bigforall}{\mbox{\Large $\mathsurround0pt\foralM$}} 

% Letters
\newcommand{\agemo}{-\omega}
\newcommand{\otp}{\mathbf{otp}}
\newcommand{\fso}{\mathbf{FSO}}
\newcommand{\mso}{\mathbf{MSO}}
\newcommand{\bounded}[1]{{#1} \text{-} \mathbf{bounded}}
\newcommand{\pp}{\mathbf{P}}
\newcommand{\qq}{\mathbf{Q}}

% Sets
\newcommand{\NN}{\mathbb{N}}
\newcommand{\ZZ}{\mathbb{Z}}

% Types
\newcommand{\type}[2]{\mathbf{type}_{#1} \brackets{#2}}

\author{Alon Gurny}
\title{Orders}
\date{\today}

\begin{document}

\maketitle

\section{Properties}
% Definition of a property
\begin{definition}
  A \emph{property} $\pp$ of linear orders is a class of linear orders which
  is closed under isomorphism.
\end{definition}

% Definition of a monotone property
\begin{definition}
  A property $\pp$ of linear orders is \emph{monotone} if for every linear order $M$,
  $M \in \pp$ implies that every suborder of $M$ is in $\pp$.
\end{definition}

% Definition of a symmetric property
\begin{definition}
  A property $\pp$ of linear orders is \emph{symmetric} if for every linear order $M$,
  $M \in \pp$ iff $M^R \in \pp$.
\end{definition}

% Definition of an additive property
\begin{definition}
  A property $\pp$ of linear orders is an \emph{additive property} if for every linear orders $M_1$ and $M_2$,
  $M_1 + M_2 \in \pp$ iff $M_1, M_2 \in \pp$.
\end{definition}

% Definition of $\bounded{\pp}$
\begin{definition}
  Let $\pp$ be a property of linear orders.

  We define $\bounded{\pp}$ to be the class of linear orders $M$ such that for every $x, y \in M$,
  the bounded subinterval $[x, y]$ is in $\pp$.
\end{definition}

% Definition of an almost anti-symmetric property
\begin{definition}
  A property $\pp$ of linear orders is \emph{almost anti-symmetric}
  if for every linear order $M$,
  $M \in \pp$ and $M^R \in \pp$ imply that $M$ is finite.
\end{definition}

% Definition of a good property
\begin{definition}
  A property $\pp$ of linear orders is \emph{good} if it is 
  monotone, additive and contains at least one infinite linear order.
\end{definition}

% Definition of a star property
\begin{definition}
  A property $\pp$ of linear orders is a \emph{star property} if 
  for every linear orders $M$, and every family $\mathcal{F} \subseteq \pp$
  of subintervals of $M$ such that $J_1 \cap J_2 \ne \emptyset$
  for every $J_1, J_2 \in \mathcal{F}$, we have that
  $\bigcup \mathcal{F} \in \pp$.
\end{definition}

  
% Lemma: $\bounded{\pp}$ is a star property
\begin{lemma}[Star Lemma]
  Let $\pp$ be an additive property of linear orders.

  Then the property $\bounded{\pp}$ has the star property.
\end{lemma}

% Proof of the star lemma
\begin{proof}
  Let $M$ be a linear order,
  and let $\mathcal{F} \subseteq \bounded{\pp}$ be a family of subintervals of $M$.

  Let $[x, y] \subseteq \bigcup \mathcal{F}$ be any bounded subinterval. We need to prove 
  it is in $\pp$.

  Suppose $x \in J_1$ and $y \in J_2$ for $J_1, J_2 \in \mathcal{F}$.
  
  Since $J_1 \cap J_2 \ne \emptyset$, we can take $z \in J_1 \cap J_2$.

  Then $[x, z] \subseteq J_1$ and $[z, y] \subseteq J_2$,
  and thus by $\bounded{\pp}$, $[x, z], [z, y] \in \pp$.
  However, $\pp$ is additive. Since $[x, y]$ is either the sum
  or difference of $[x, z]$ and $[z, y]$, we have that $[x, y] \in \pp$.
\end{proof}

% Partition according to a star property
\begin{lemma}
  Let $\pp$ be a star property.

  Then for every linear order $M$,
  and every point $x \in M$, there exists a largest subinterval $J \subseteq M$ such that
  $J \in \pp$.

  Thus, we can define an equivalence relation $\sim_{\pp}$ on $M$ such that
  $x \sim_{\pp} y$ iff $x$ and $y$ are in the same largest $\pp$-subinterval.
\end{lemma}

\begin{proof}
  Let $J \subseteq M$ be the union of all $\bounded{\pp}$-subintervals containing $x$.
  All such subintervals intersect at $x$.

  Therefore, by the star lemma, $J$ is in $\bounded{\pp}$, and by definition
  $J$ is the largest $\pp$-subinterval containing $x$.

  Thus we can define the equivalence relation $\sim_{\pp}$ as above.
\end{proof}

\section{Hausdorff Rank}

% Definition of the Hausdorff rank
\begin{definition}
  Let $\qq$ be a good property of linear orders.

  We define a property $\qq^{\le \alpha}$
  for every ordinal $\alpha$ as follows:
  
  \begin{itemize}
    \item $\qq^{\le 0}$ is the class of finite linear orders.
    \item For $\alpha > 0$, $\qq^{\le \alpha}$ is the class of linear orders $M$ such that
          $M = \sum_{i \in I} M_i$ for some $I \in \qq$ where 
          for all $i \in I$, $M_i \in \qq^{\beta_i}$ for some $\beta_i < \alpha$
  \end{itemize}

  We define further $\qq^{< \alpha} = \bigcup_{\beta < \alpha} \qq^{\le \beta}$
  and $\qq^{=\alpha} = \qq^{\le \alpha} - \qq^{< \alpha}$.

  We define $\hrank{M} = \alpha$ iff $M \in \qq^{= \alpha}$.
  This is a \emph{partial map} from linear orders to ordinals.
\end{definition}

\begin{observations}
  Let $\qq$ be a good property.

  We claim the following without proof:

  \begin{itemize}
    \item $\qq^{\le 1} = \qq$.
    \item For all $\alpha$, $\qq^{\le \alpha}$ is a good property.
    \item $\qq^{\le \alpha} \subsetneq \qq^{\le \beta}$ iff $\alpha < \beta$.
  \end{itemize}
\end{observations}

\begin{definitions}
  $\mathcal{B}_{< \alpha} := \bounded{\qq^{< \alpha}}$ is the class
  of linear orders of rank $< \alpha$ on bounded intervals.

  $\mathcal{R}_{< \alpha}$ is the class
  of linear orders $M$ where $M + 1 \in \mathcal{B}_{< \alpha}$.

  $\mathcal{L}_{< \alpha}$ is the class
  of linear orders $M$ where $1 + M \in \mathcal{B}_{< \alpha}$.
\end{definitions}

\begin{claim}
  The following are equal:

  \begin{enumerate}
    \item $\qq^{< \alpha}$
    \item $\setcomp{M : 1 + M + 1 \in \mathcal{B}_{< \alpha}}$.
    \item $\mathcal{L}_{< \alpha} \cap \mathcal{R}_{< \alpha}$
  \end{enumerate}

\end{claim}

\begin{proof}
  The only nontrivial direction is 3 implies 2, which follows from the star property
  of $\mathcal{B}_{< \alpha}$.
\end{proof}

\begin{lemma}
  A countable linear order which has rank $< \alpha$ 
  on bounded subintervals is of rank $\le \alpha$.
  That is,

  $$\mathcal{B}_{< \alpha} \subseteq \qq^{\le \alpha}$$
\end{lemma}

\begin{proof}
  Let $M$ be a countable linear order of rank $< \alpha$.

  Then $M = \sum_{i \in I} M_i$ where $M_i \in \qq^{< \alpha}$.

  Let $\setcomp{x_i}_{i \in I} \subseteq M$ be a bidirectional, cofinal, weakly monotone $I$-sequence in $M$, i.e,
  $x_i \le x_j$ if $i \le j$ for $I \subseteq \ZZ$.

  Write $M = \sum_{i \in I} [x_i, x_{i+1}]$. Then every $[x_i, x_{i+1}]$ is of Hausdorff rank $< \alpha$.

  Thus, $\hrank{M} \le \alpha$, which completes the proof.
\end{proof}

\begin{lemma}
  Let $M$ be a countable linear order.

  Then $\hrank{M} \le \alpha$ iff $M$ is a finite sum of $\mathcal{B}_{< \alpha}$-subintervals.

  Note: this lemma does not work if we take a general $\qq$ property.
\end{lemma}

\begin{proof}
  From the previous lemma, it is clear that if $M$ is a finite sum of $\mathcal{B}_{< \alpha}$-subintervals,
  then $\hrank{M} \le \alpha$, since the rank bound is preserved under finite sums.

  Conversely, suppose $\hrank{M} \le \alpha$.

  If $M = \sum_{i \in \ZZ} M_i$ for some $M_i$ of Hausdorff rank $< \alpha$,
  take $x, y \in M$. Then let $x \in M_{i_1}$ and $y \in M_{i_2}$.

  Then $[x, y] \subseteq \sum_{i \in [i_1, i_2]} M_i$. But the last sum is of rank $< \alpha$
  and thus $[x, y]$ is of rank $< \alpha$. That is, $M \in \mathcal{B}_{< \alpha}$.

  Since every subinterval of rank $\le \alpha$ is a finite sum of $\ZZ$-sums of intervals of rank $< \alpha$,
  we are done.
\end{proof}

\section{Decidability of the rank}

\begin{definition}
  Let $M$ be a linear order and $x \in M$.

  We define the convex equivalence relation $\sim_\alpha := \sim_{\mathcal{B}_{< \alpha}}$,
  and $\brackets{x}_{\alpha} := \brackets{x}_{\mathcal{B}_{< \alpha}}$ (that is,
  $\brackets{x}_{\alpha}$ is the largest $\mathcal{B}_{< \alpha}$-subinterval
  containing $x$ in $M$).
\end{definition}

\begin{lemma}
  Let $M$ be a linear order. Let $P, L, R \subseteq M$ be relations, such that:

  \begin{itemize}
    \item $P$ represents $\sim_{\alpha}$ on $M$.
    \item $L$ is such that $x \in L$ iff $\brackets{x}_{\alpha} \in \mathcal{L}_{< \alpha}$.
    \item $R$ is such that $x \in R$ iff $\brackets{x}_{\alpha} \in \mathcal{R}_{< \alpha}$.
  \end{itemize}

  Then for some linear order $I$ there exists a decomposition
  $M = \sum_{i \in I} M_i$ such that $M_i \in \mathcal{B}_{< \alpha}$ for all $i \in I$,
  $M_i$ is monochromatic with respect to $P$, $L$ and $R$.

  Furthermore, let $\tau_i$ be the $n$-type of $M_i, p_i, q_i, r_i$ in $\mso[p, \ell, r]$,
  where $p_i = 1_{M_i \subseteq P}$, $q_i = 1_{M_i \subseteq L}$ and $r_i = 1_{M_i \subseteq R}$.
  Then the following hold
  \begin{itemize}
    \item if $i$ has a successor, $p(\tau_i) \ne p(\tau_{i+1})$
    \item if $i$ has a successor, either $r(\tau_i) = 0$ or $\ell(\tau_{i+1}) = 0$
  \end{itemize}
\end{lemma}
\begin{proof}
  Take $I = M / \sim_{\alpha}$.

  Then $M = \sum_{i \in I} M_i$ where $M_i$ is the $\sim_{\alpha}$-equivalence class of $i$.

  Then $M_i$ is monochromatic with respect to $P$, $L$ and $R$.

  The only thing left to prove is the last two conditions. The first follows from
  the fact that $P$ represents $\sim_{\alpha}$.

  The second follows because if it were not the case, then $M_i$ and $M_{i+1}$ would
  be the same $\sim_{\alpha}$-equivalence class.
\end{proof}

\begin{lemma}
  Let $I$ be a linear order. Let $n \in \NN$. Let $p, \ell, r$ be boolean variables.

  Let $\tau_i$ be an assignment of satisfiable $n$-types in $\mso[p, \ell, r]$ for all $i \in I$. Assume that
  \begin{itemize}
    \item if $i$ has a successor, $p(\tau_i) \ne p(\tau_{i+1})$
    \item if $i$ has a successor, either $r(\tau_i) = 0$ or $\ell(\tau_{i+1}) = 0$
  \end{itemize}

  Then there exists a linear order $M$ and $P, L, R \subseteq M$ such that:
  \begin{itemize}
    \item $P$ represents $\sim_{\alpha}$ on $M$.
    \item $L$ is such that $x \in L$ iff $\brackets{x}_{\alpha} \in \mathcal{L}_{< \alpha}$.
    \item $R$ is such that $x \in R$ iff $\brackets{x}_{\alpha} \in \mathcal{R}_{< \alpha}$.
  \end{itemize}

  such that for all $i \in I$, $M_i$ is a $\sim_{\alpha}$-equivalence class of $M$,
  and is thus monochromatic with respect to $P$, $L$ and $R$.

  Furthermore, the $n$-type of $M_i, p_i, q_i, r_i$ in $\mso[p, \ell, r]$ is $\tau_i$, where
  $p_i = 1_{M_i \subseteq P}$, $q_i = 1_{M_i \subseteq L}$ and $r_i = 1_{M_i \subseteq R}$,
\end{lemma}


\begin{proof}
  Since $\tau_i$ is satisfiable, we can take $M_i$ to be a linear order of $n$-type
  $\tau_i$ such that:

  \begin{itemize}
    \item If $\ell(\tau_i) = r(\tau_i) = 1$, then $M_i \in \mathcal{L}_{< \alpha} \cap \mathcal{R}_{< \alpha}$.
    \item If $\ell(\tau_i) = 1$ and $r(\tau_i) = 0$, then $M_i \in \mathcal{L}_{< \alpha} - \mathcal{R}_{< \alpha}$.
    \item If $\ell(\tau_i) = 0$ and $r(\tau_i) = 1$, then $M_i \in \mathcal{R}_{< \alpha} - \mathcal{L}_{< \alpha}$.
    \item If $\ell(\tau_i) = r(\tau_i) = 0$, then $M_i \in \mathcal{B}_{< \alpha} - (\mathcal{L}_{< \alpha} \cup \mathcal{R}_{< \alpha})$.
  \end{itemize}

  Let $M = \sum_{i \in I} M_i$.

  By definition each $M_i$ is in $\mathcal{B}_{< \alpha}$. We need to prove
  that each $M_i$ is a largest $\mathcal{B}_{< \alpha}$-subinterval in $M$.

  On the contrary, suppose that there exist $i' \ne i$ such that $[M_i, M_{i'}] \in \mathcal{B}_{< \alpha}$.
  WLOG, $M_i < M_{i'}$.

  Since $I$ is scattered, take some $i \le a < b \le i'$ such that
  there is no element between $a$ and $b$ in $I$.

  Then $M_a \in \mathcal{R}_{< \alpha}$ and $M_b \in \mathcal{L}_{< \alpha}$, in contradiction.
\end{proof}

\begin{lemma}
  Over countable linear orders with interpretations of $P$, $L$ and $R$ as above, the properties
  $\hrank{\cdot} \le \alpha$, $\hrank{\cdot} < \alpha$ and $\hrank{\cdot} = \alpha$
  over subintervals are all expressible in $\mso[P, L, R]$.
\end{lemma}

\begin{proof}
  For $\hrank{\cdot} \le \alpha$ and $\hrank{\cdot} < \alpha$, we can use the previous lemmas.

  For $\hrank{\cdot} = \alpha$, we can use the previous two.
\end{proof}


\begin{lemma}
  There exists a global computable function $f : \NN \to \NN$ such that
  for all $n \in \NN$,
  $\type{n}{\mathcal{H}_{f(n) + 1}} = \type{n}{\mathcal{H}_{f(n)}}$.

  Equivalently, every linear order of finite rank is $n$-equivalent to some linear order of rank $\le f(n)$.
\end{lemma}

\begin{proof}
  Since there exist only a finite number of $n$-types,
  and the $\omega$-sequence $\braces{\type{n}{\mathcal{H}_{k}}}_{k \in \omega}$ is monotone,
  it must stabilize at some point.

  This point is computable as a function of $n$, because
  $\type{n}{\mathcal{H}_{k}}$ is computable for every finite $k$.
\end{proof}


\begin{lemma}
  There exist global computable functions $a, b : \NN \to \NN$ such that
  for all $n, c_1, c_2 \in \NN$ such that $c_1, c_2 \ge a(n)$ and $c_1 \equiv c_2 \mod b(n)$,
  $$\type{n}{\mathcal{H}_{c_1}} = \type{n}{\mathcal{H}_{c_2}}$$

  Equivalently, the sequence $\braces{\type{n}{\mathcal{H}_{k}}}_{k \in \omega}$ 
  is ultimately periodic for all $n \in \NN$. Furthermore, the starting point and the period
  itself can be computed as a function of $n$.
\end{lemma}

\begin{proof}
  Let $n \in \NN$.

  Since there exist only a finite number of possible
  sets of $n$-types, there exist (and can be computed)
  some $a(n) > f(n)$, $a(n) + b(n)$ such that
  
  $$\type{n}{\mathcal{H}_{a(n)}} = \type{n}{\mathcal{H}_{a(n) + b(n)}}$$
  
  We shall prove by induction that for all $c \ge a(n) + b(n)$,

  $$\type{n}{\mathcal{H}_{c}} = \type{n}{\mathcal{H}_{c + b(n)}}$$

  This will complete the proof.

  The base case $c = a(n)$ has been proven in the beginning.

  Suppose the induction hypothesis holds for $c$.

  Let $M$ be of rank $c + 1$.

  Write $M = \sum_{i \in I} M_i$ where $\hrank{M_i} < c + 1$,
  and $\hrank{M_i} = c$ infinitely many times.

  By the induction hypothesis,
  if $\hrank{M_i} = c$, we can find $N_i \equiv_n M_i$ with $\hrank{N_i} = c + b(n)$.
  Setting $N_i := M_i$ for all other $i$, we conclude that $N := \sum_{i \in I} N_i$
  is $n$-equivalent to $M$.

  However, clearly $\hrank{N} = c + b(n) + 1$. So overall,
  $$\type{n}{\mathcal{H}_{c + 1}} \subseteq \type{n}{\mathcal{H}_{c + b(n) + 1}}$$

  Conversely, suppose $M$ is of rank $c + b(n) + 1$.
  Write $M$ = $\sum_{i \in I} M_i$ where $\hrank{M_i} < c + b(n) + 1$,
  and $\hrank{M_i} = c + b(n)$ infinitely many times.

  By the induction hypothesis,
  we can find for all $i$ such that $\hrank{M_i} = c + b(n)$ some 
  $N_i \equiv_n M_i$ with $\hrank{N_i} = c$.
  Furthermore, since $c \ge a(n) > f(n)$, we can
  find $N_i \equiv_n M_i$ with $\hrank{N_i} \le f(n) < c$ for all other $i$.

  We conclude that $N := \sum_{i \in I} N_i$ is $n$-equivalent to $M$.
  However, clearly $\hrank{N} = c + 1$. So overall,
  $$\type{n}{\mathcal{H}_{c + b(n) + 1}} \subseteq \type{n}{\mathcal{H}_{c + 1}}$$

  So we have proven the induction step, and the lemma follows.
\end{proof}

\begin{lemma}
  Let $n \in \NN$, and let $\alpha \ge \omega$ be an ordinal.

  Then,
  $$\type{n}{\qq^{= \alpha}} = \bigcup_{c < b(n)}{\type{n}{\mathcal{H}_{c + b(n)}}}$$

  In particular, $\type{n}{\qq^{= \alpha}}$ can be
  computed, and is independent of the choice $\alpha \ge \omega$.
\end{lemma}

\begin{proof}
  TBC.
\end{proof}

\begin{corollary}
  The following sequences stabilize at $f(n)$:

  \begin{itemize}
    \item $\type{n}{\mathcal{H}_{\alpha}}$
    \item $\type{n}{\mathcal{B}_{< \alpha}}$
    \item $\type{n}{\mathcal{L}_{< \alpha}}$
    \item $\type{n}{\mathcal{R}_{< \alpha}}$
    \item $\type{n}{\mathcal{L}_{< \alpha} - \mathcal{R}_{< \alpha}}$
    \item $\type{n}{\mathcal{R}_{< \alpha} - \mathcal{L}_{< \alpha}}$
    \item $\type{n}{\mathcal{B}_{< \alpha} - (\mathcal{L}_{< \alpha} \cup \mathcal{R}_{< \alpha})}$
  \end{itemize}
\end{corollary}

\begin{proof}
  The corollary is false and should be fixed.
\end{proof}

\begin{theorem}
  There is a an algorithm solving satisfiability for $\mso[P, L, R]$ over countable linear orders,
  given an oracle which solves the satisfiability problem for $\mso$ over countable linear orders.
\end{theorem}

\begin{proof}
  By the decomposition theorem, there exists a translation,
  that given an $\mso[P, L, R]$ formula $\varphi$ of quantifier-depth $n$.
  outputs an $\mso[\setcomp{X_\tau}_\tau]$ formula $\psi$.

  Let $P_L, Q_L, R_M$ be the interpretations of $P, L, R$ on $M$.

  Then

  $$
    M, P := P_L, L := Q_L, R := R_L \models \varphi \iff I, \setcomp{X_\tau := I_\tau}_\tau \models \psi
  $$

  Where $I_\tau = \setcomp{i \in I : M_i \models \tau}$ for every $n$-type $\tau$.

  Let $T$ be the set of $n$-types in $\mso[p, \ell, r]$ which satisfy
  $\ell(\tau) = 1 \iff \tau \in \mathcal{L}_{< \alpha}$ and $r(\tau) = 1 \iff \tau \in \mathcal{R}_{< \alpha}$.

  Let $S = \setcomp{(\tau_1, \tau_2) : p(\tau_1) \ne p(\tau_2) \land (r(\tau_1) = 0 \lor \ell(\tau_2) = 0)}$.

  Then $T$ and $S$ can be calculated using the oracle.

  Then $\psi$ is an $\mso[T, S]$ formula.

  Then we define an $\mso[p, \ell, r]$ formula $\psi'$ as follows:

  $\psi'$ claims that there exists a partition (with possible empty sets) $\setcomp{Y_\tau}_{\tau}$ of $I$ such that
  \begin{itemize}
    \item Every $i \in I$ is in some $Y_\tau$ for $\tau \in T$.
    \item If $i' = i+1$ in $I$, then for some $(\tau_1, \tau_2) \in S$, $i \in Y_{\tau_1}$ and $i' \in Y_{\tau_2}$.
  \end{itemize}

  Now we claim that $\varphi$ is satisfiable in some linear order, iff $\psi'$ is satisfiable in some
  linear order.

  Suppose $\varphi$ is satisfiable in some linear order $M$.

  Take a decomposition $M = \sum_{i \in I} M_i$ as in lemma 2.

  Then $\psi$ holds over the assignment $X_\tau := I_\tau$. But by lemma 2, this assignment
  satisfies the condition required for $\psi'$ to hold. Then $\psi'$ holds over $I$.

  Conversely, suppose $\psi'$ holds in $I$.

  Let $X_\tau := Z_\tau$ be the assignment that is guaranteed by $\psi'$.

  Let $tau_i$ be the unique $\tau$ such that $i \in Z_\tau$.

  Then the conditions for lemma 3 are guaranteed.

  Thus, take $M$ as in lemma 3. Then $\psi$ holds over $I$ when we set $X_i := Z_\tau$.
  But $Z_\tau = I_\tau$ for all $\tau$, so $\varphi$ holds over $M$.
\end{proof}

\end{document}
